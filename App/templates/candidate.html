<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Video Call</title>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.0.js"></script>
    <style>
        #local-video, #remote-video {
            width: 480px;
            height: 360px;
            border: 1px solid black;
        }
    </style>
</head>
<body>
    <h2>Simple Video Call</h2>
    <div>
        <h3>local</h3>
        <div id="local-video"></div>
        <h3>remote</h3>
        <div id="remote-video"></div>
    </div>

    <script>
        var client = AgoraRTC.createClient({mode: "rtc", codec: "vp8"});
        var localTracks = [];
        var isJoiningChannel = false;
        var isChannelJoined = false;

        async function joinChannel(token, channelName, uid) {
            if (isJoiningChannel || isChannelJoined) {
                console.log("Joining process is ongoing or already connected to the channel.");
                return;
            }
            isJoiningChannel = true;
            try {
                await client.join("b5a04df0256a451ebec8ee8774ef85ff", channelName, token, uid);
                localTracks = await AgoraRTC.createMicrophoneAndCameraTracks();
                localTracks[1].play("local-video");
                await client.publish(localTracks);
                console.log("Publish local streams successfully");
                isChannelJoined = true;
            } catch (error) {
                console.error('Error joining the channel:', error);
            } finally {
                isJoiningChannel = false;
            }
        }

        client.on("user-published", async (user, mediaType) => {
            await client.subscribe(user, mediaType);
            console.log("subscribe success");
            if (mediaType === "video") {
                user.videoTrack.play("remote-video");
            }
            if (mediaType === "audio") {
                user.audioTrack.play();
            }
        });

        client.on("user-unpublished", user => {
            console.log("unpublished user", user);
            // 可以在这里处理用户停止发布的逻辑
        });

        async function leaveChannel() {
            for (let track of localTracks) {
                track.stop();
                track.close();
            }
            await client.leave();
            isChannelJoined = false;
            console.log("Client leaves channel");
        }

        function getTokenAndJoinChannel(channelName, uid) {
            fetch(`/vac/get_token?channelName=${channelName}&uid=${uid}`)
                .then(response => response.json())
                .then(data => {
                    joinChannel(data.token, channelName, uid);
                })
                .catch(error => console.error('Error:', error));
        }

        var channelName = "testChannel";
        var uid = Math.floor(Math.random() * 10000);
        getTokenAndJoinChannel(channelName, uid);
    </script>
</body>
</html>
