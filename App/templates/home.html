<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    {% extends 'base.html' %}
    {% block title %}Home{% endblock %}

    <link rel="stylesheet" href="../static/home.css"/>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% block scripts %}
    <script>
        $(document).ready(function () {
            // Fetch positions and available times when the document is ready
            fetchPositions();
            fetchAvailableTimes();

            // Function to fetch positions from the server
            function fetchPositions() {
                $.ajax({
                    url: '/get-positions', // URL to your backend endpoint that returns positions
                    type: 'GET',
                    success: function (positions) {
                        positions.forEach(function (position) {
                            $('#positionSelect').append(`<option value="${position.PID}">${position.positionName}</option>`);
                        });
                    },
                    error: function (error) {
                        console.log('Error fetching positions:', error);
                    }
                });
            }

            // Function to fetch available times from the server
            function fetchAvailableTimes() {
                $.ajax({
                    url: '/get-available-times', // URL to your backend endpoint that returns available times
                    type: 'GET',
                    success: function (times) {
                        times.forEach(function (time) {
                            $('#timeSelect').append(`<option value="${time.MID}">${time.startTime} - ${time.endTime}</option>`);
                        });
                    },
                    error: function (error) {
                        console.log('Error fetching times:', error);
                    }
                });
            }

            // Handle form submission
            $('#applicationForm').on('submit', function (e) {
                e.preventDefault(); // Prevents the default form submission

                var applicationData = {
                    position: $('#positionSelect').val(),
                    time: $('#timeSelect').val(),
                    salary: $('#expectedSalary').val(),
                    introduction: $('#selfDescription').val()
                };

                console.log('Submitting application:', applicationData); // Debugging log

                $.ajax({
                    url: '/submit-application',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(applicationData),
                    success: function (response) {
                        alert('Application submitted successfully');
                    },
                    error: function (response) {
                        alert('Error submitting application');
                    }
                });
            });




            function fetchApplications() {
                $.ajax({
                    url: '/view-applications',
                    type: 'GET',
                    success: function (applications) {
                        let tableHtml = '<table>';
                        tableHtml += '<tr><th>Position Name</th><th>Time Period</th><th>Status</th></tr>'; // Table headers

                        applications.forEach(function (app) {
                            // Formatting status
                            let statusText = app.status === 0 ? 'Reject' : 'Accept';

                            tableHtml +=
                                `<tr>
                                    <td>${app.position}</td>
                                    <td>${app.meeting_room.start_time} - ${app.meeting_room.end_time}</td>
                                    <td>${statusText}</td>
                                </tr>`;
                        });

                        tableHtml += '</table>';
                        $('#applicationsList').html(tableHtml);
                    },
                    error: function (error) {
                        console.log('Error fetching applications:', error);
                        $('#applicationsList').html('Error fetching applications.');
                    }
                });
            }

            // Event listener for the 'View My Applications' button
            $('#viewApplicationsButton').click(function () {
                fetchApplications();
            });

            function fetchInterviewResults() {
                $.ajax({
                    url: '/view-interview-results',
                    type: 'GET',
                    success: function (results) {
                        let tableHtml = '<table>';
                        tableHtml += '<tr><th>Position Name</th><th>Time Period</th><th>Status</th></tr>'; // Table headers

                        results.forEach(function (result) {
                            tableHtml +=
                                `<tr>
                                <td>${result.positionName}</td>
                                <td>${result.timePeriod}</td>
                                <td>${result.status}</td>
                            </tr>`;
                        });

                        tableHtml += '</table>';
                        $('#interviewResultsList').html(tableHtml);
                    },
                    error: function (error) {
                        console.log('Error fetching interview results:', error);
                        $('#interviewResultsList').html('Error fetching interview results.');
                    }
                });
            }

            // Event listener for button click
            $('#viewInterviewResultsButton').click(function () {
                fetchInterviewResults();
            });


        });
    </script>
{% endblock %}
</head>

<body>

{% block content %}
<h1>Check out your interviews!</h1>

<div class="application-form">
    <h2>Submit Your Application</h2>
    <form id="applicationForm">
        <label for="positionSelect">Position:</label>
        <select id="positionSelect" required>
            <option value="">Select a position</option>
            <!-- Positions will be filled by AJAX -->
        </select>
        <br>

        <label for="timeSelect">Available Interview Time:</label>
        <select id="timeSelect" required>
            <option value="">Select a time</option>

        </select>
        <br>

        <label for="expectedSalary">Expected Salary:</label>
        <input type="number" id="expectedSalary" required>
        <br>

        <label for="selfDescription">Self Description:</label>
        <textarea id="selfDescription" required></textarea>
        <br>

        <button type="submit">Submit Application</button>
    </form>
</div>

<div class="view-applications">
    <button id="viewApplicationsButton">View My Applications</button>
    <div id="applicationsList"></div>
</div>

<div class="view-interview-results">
    <button id="viewInterviewResultsButton">View My interview result</button>
    <div id="interviewResultsList"></div>
</div>


{% endblock %}
</body>

</html>
